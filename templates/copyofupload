<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Receipt</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <style>
        .step { display: none; }
        .step.active { display: block; }
    </style>
</head>
<body>
    <nav class = "navbar navbar-expand-lg navbar-dark bg-dark">
        <a class = "navbar-brand" href = "#">Scan2Save</a>
    </nav>
    <div class="row">
        <div class="container d-flex justify-content-center" style="margin-top: 20px;">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h1 class="text-center mb-4">Upload Expenses</h1>                                            
                        <form id="multiStepForm" action="/upload" method="POST" enctype="multipart/form-data">
                            <!--step 1-->
                            <div class="step active">
                                <h2>Upload Excel File</h2>
                                <div class="my-4 form-group">                                    
                                    <input type="file" id="excelFile" class="form-control-file" name="file" accept=".xlsx,.xls">
                                </div>
                                <div class="row">
                                    <button type="button" class="col-6 text-center mx-auto btn btn-primary btn-block" onclick="nextStep()">Next</button>
                                </div>
                            </div>
                            <!--step 2-->
                            <div class="step">
                                <h2>Upload Image of Receipt</h2>
                                <div class="row">
                                    <div class="col-6">
                                        <form onsubmit="addReceipt(); return false;" class="my-3 col-6 form-group">
                                            <input type="file" class="form-control-file col-6 mb-3" name="file" accept="image/*">
                                        </form>            
                                    </div>                        
                                </div>
                                <div class="col-6">
                                    <button type="button" class="col-6 btn" onclick="addReceipt()">Add Another Receipt</button>
                                </div>
                                <div class="row">
                                    <div class="col-6 form-group" id="additionalReceipts">
                                        <!-- <ul id="receiptList"></ul> -->
                                    </div>
                                    <div class="col-6" id="extraSpace"></div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <button type="button" class="btn btn-secondary btn-block" onclick="prevStep()">Back</button>
                                    </div>
                                    <div class="col-6">
                                        <button type="button" class="btn btn-primary btn-block" onclick="nextStep()">Next</button>                                
                                    </div>
                                </div>
                            </div>
                            <!--step 3-->
                            <div class="step">
                                <h2>Review, Make Changes, and Submit</h2>                                
                                <div class="row">
                                    <div class="col-12">
                                        <h3>Receipt Summary</h3>
                                        <div id="receiptSummary"></div> <!-- Add this line -->
                                    </div>
                                </div>

                                <div class="row">                                    
                                    <!-- <div class="col-6">
                                        <button type="button" class="btn btn-secondary btn-block" onclick="prevStep()">Back</button>
                                    </div> -->
                                    <div class="col-6 justify-content-center">
                                        <button type="submit" class="btn btn-block btn-success">Submit</button>
                                    </div>
                                </div>
                            </div>
                        </form>                                      
                    </div>         
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p class="text-center">&copy;Zach and Martin</p>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>    
        <script>
            let currentStep = 0;
let numReceipts = 0;
let receiptValues = [];
const steps = document.querySelectorAll('.step');

function showStep(step) {
    steps.forEach((stepElement, index) => {
        stepElement.classList.toggle('active', index === step);
    });
}

function nextStep() {
    if (currentStep < steps.length - 1) {
        currentStep++;
        showStep(currentStep);
    }
    if (currentStep === steps.length - 1) {
        displayResults();
    }
}

function prevStep() {
    if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
    }
}

function addReceipt() {
    numReceipts++;

    var newReceipt = document.createElement('div');
    newReceipt.className = 'form-group mb-3';
    newReceipt.innerHTML = `
        <label for="date${numReceipts}">Date</label>
        <input type="date" class="form-control" id="date${numReceipts}" name="date">
        <label for="price${numReceipts}">Price</label>
        <input type="text" class="form-control" id="price${numReceipts}" name="price">
        <label for="merchant${numReceipts}">Merchant</label>
        <input type="text" class="form-control" id="merchant${numReceipts}" name="merchant">
    `;
    document.getElementById('receiptList').appendChild(newReceipt);

    var input = document.createElement("input");
    input.type = "file";
    input.className = "form-control-file";
    input.name = "file";
    input.accept = "image/*";

    input.addEventListener('change', function(event) {
        var formData = new FormData();
        formData.append('file', input.files[0]);

        fetch('/getData', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            receiptValues.push({
                date: data.date,
                price: data.price,
                merchant: data.merchant,
                file: input.files[0]
            });
            document.getElementById(`date${numReceipts}`).value = data.date;
            document.getElementById(`price${numReceipts}`).value = data.price;
            document.getElementById(`merchant${numReceipts}`).value = data.merchant;

            // Update the results on step 3
            if (currentStep === steps.length - 1) {
                displayResults();
            }
        })
        .catch(error => console.error('Error:', error));
    });

    document.getElementById('additionalReceipts').appendChild(input);
}

function displayResults() {
    var receiptSummary = document.getElementById('receiptSummary');
    receiptSummary.innerHTML = '';

    for (let i = 0; i < receiptValues.length; i++) {
        var div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <h4>Receipt ${i + 1}</h4>
            <div class="row">
                <div class="col-4">
                    <label>Date</label>
                    <input type="date" class="form-control" value="${receiptValues[i].date}" onchange="updateReceipt(${i}, 'date', this.value)">
                </div>
                <div class="col-4">
                    <label>Price</label>
                    <input type="text" class="form-control" value="${receiptValues[i].price}" onchange="updateReceipt(${i}, 'price', this.value)">
                </div>
                <div class="col-4">
                    <label>Merchant</label>
                    <input type="text" class="form-control" value="${receiptValues[i].merchant}" onchange="updateReceipt(${i}, 'merchant', this.value)">
                </div>
            </div>
        `;
        receiptSummary.appendChild(div);
    }
}

function updateReceipt(index, field, value) {
    receiptValues[index][field] = value;
}

document.addEventListener('DOMContentLoaded', function() {
    showStep(currentStep);
});

        </script>
        <script src="{{ url_for('static', filename='js/upload.js') }}"></script>
    </footer>
</body>
</html>